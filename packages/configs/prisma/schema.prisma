// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/prisma/gen"

  engineType   = "client"
  runtime      = "nodejs"
  moduleFormat = "esm"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Configuration {
  pk                   Int               @id @default(autoincrement())
  selectedTarget       Int?
  selectedOiTarget     Int?
  selectedP1Target     Int?
  selectedP2Target     Int?
  selectedGuiderTarget Int?
  oiGuidingType        GuidingType
  p1GuidingType        GuidingType
  p2GuidingType        GuidingType
  obsTitle             String?
  obsId                String?
  obsInstrument        String?
  obsSubtitle          String?
  obsReference         String?
  baffleMode           BaffleMode        @default(AUTO)
  centralBaffle        CentralBaffle?
  deployableBaffle     DeployableBaffle?
}

enum GuidingType {
  NORMAL
}

enum BaffleMode {
  AUTO
  MANUAL
  IGNORED
}

enum CentralBaffle {
  CLOSED
  OPEN
}

enum DeployableBaffle {
  EXTENDED
  NEAR_IR
  THERMAL_IR
  VISIBLE
}

model EngineeringTarget {
  pk               Int               @id @default(autoincrement())
  id               String
  name             String            @default("Test")
  coord1           Float // RA or Az
  coord2           Float // Dec or El
  pmRa             Float? // Proper Motion RA microArcsec/Year
  pmDec            Float? // Proper Motion Dec microArcsec/Year
  radialVelocity   Float? // cm/s
  parallax         Float? // microArcsec
  epoch            String?
  type             TargetType        @default(FIXED)
  wavelength       Int?
  createdAt        DateTime          @default(now())
  instrument       String
  rotatorMode      TrackingType?
  rotatorAngle     Float?
  baffleMode       BaffleMode        @default(AUTO)
  centralBaffle    CentralBaffle?
  deployableBaffle DeployableBaffle?
}

model Target {
  pk             Int        @id @default(autoincrement())
  id             String
  name           String     @default("Test")
  coord1         Float // RA or Az
  coord2         Float // Dec or El
  pmRa           Float? // Proper Motion RA microArcsec/Year
  pmDec          Float? // Proper Motion Dec microArcsec/Year
  radialVelocity Float? // cm/s
  parallax       Float? // microArcsec
  magnitude      Float? // Magnitude number (Brightness)
  band           String? // Magnitude band
  epoch          String     @default("J2000.000")
  type           TargetType @default(SCIENCE)
  wavelength     Int?
  createdAt      DateTime   @default(now())
}

enum TargetType {
  FIXED
  SCIENCE
  BLINDOFFSET
  OIWFS
  PWFS1
  PWFS2
}

model Instrument {
  pk          Int      @id @default(autoincrement())
  name        String
  iaa         Float    @default(0.0)
  issPort     Int
  focusOffset Float    @default(0.0)
  wfs         WfsType  @default(NONE)
  originX     Float    @default(0.0)
  originY     Float    @default(0.0)
  ao          Boolean  @default(false)
  extraParams Json
  isTemporary Boolean  @default(true)
  comment     String?
  createdAt   DateTime @default(now())
}

enum WfsType {
  NONE
  PWFS1
  PWFS2
  OIWFS
}

model Rotator {
  pk       Int          @id @default(autoincrement())
  angle    Float        @default(0.0)
  tracking TrackingType @default(TRACKING)
}

enum TrackingType {
  TRACKING
  FIXED
}

model SlewFlags {
  pk                       Int     @id @default(autoincrement())
  zeroChopThrow            Boolean
  zeroSourceOffset         Boolean
  zeroSourceDiffTrack      Boolean
  zeroMountOffset          Boolean
  zeroMountDiffTrack       Boolean
  shortcircuitTargetFilter Boolean
  shortcircuitMountFilter  Boolean
  resetPointing            Boolean
  stopGuide                Boolean
  zeroGuideOffset          Boolean
  zeroInstrumentOffset     Boolean
  autoparkPwfs1            Boolean
  autoparkPwfs2            Boolean
  autoparkOiwfs            Boolean
  autoparkGems             Boolean
  autoparkAowfs            Boolean
}

model Mechanism {
  pk                Int    @id @default(autoincrement())
  mcs               Status
  mcsPark           Status
  mcsUnwrap         Status
  scs               Status
  crcs              Status
  crcsPark          Status
  crcsUnwrap        Status
  pwfs1             Status
  pwfs1Park         Status
  pwfs1Unwrap       Status
  pwfs2             Status
  pwfs2Park         Status
  pwfs2Unwrap       Status
  oiwfs             Status
  oiwfsPark         Status
  odgw              Status
  odgwPark          Status
  aowfs             Status
  aowfsPark         Status
  dome              Status
  domePark          Status
  domeMode          String
  shutters          Status
  shuttersPark      Status
  shutterMode       String
  shutterAperture   Int
  wVGate            Status
  wVGateClose       Status
  wVGateValue       Int
  eVGate            Status
  eVGateClose       Status
  eVGateValue       Int
  agScienceFoldPark Status
  agAoFoldPark      Status
  agAcPickoffPark   Status
  agParkAll         Status
}

enum Status {
  PENDING
  ACTIVE
  DONE
  ERROR
}

model AltairInstrument {
  pk             Int     @id @default(autoincrement())
  beamsplitter   String
  startMagnitude Float
  seeing         Float
  windSpeed      Float
  forceMode      Boolean
  ndFilter       Boolean
  fieldLens      Boolean
  deployAdc      Boolean
  adjustAdc      Boolean
  lgs            Boolean
}

model GemsInstrument {
  pk              Int     @id @default(autoincrement())
  adc             Boolean
  beamsplitter    String
  astrometricMode String
}

model GuideLoop {
  pk                        Int     @id @default(autoincrement())
  m2TipTiltEnable           Boolean
  m2TipTiltSource           String
  m2FocusEnable             Boolean
  m2FocusSource             String
  m2TipTiltFocusLink        Boolean
  m2ComaEnable              Boolean
  m1CorrectionsEnable       Boolean
  m2ComaM1CorrectionsSource String
  mountOffload              Boolean
  daytimeMode               Boolean
  probeTracking             String
  lightPath                 String
}

model AltairGuideLoop {
  pk        Int     @id @default(autoincrement())
  aoEnabled Boolean
  oiBlend   Boolean
  focus     Boolean
  p1Ttf     Boolean
  strap     Boolean
  oiTtf     Boolean
  ttgs      Boolean
  sfo       Boolean
}

model GemsGuideLoop {
  pk        Int     @id @default(autoincrement())
  aoEnabled Boolean
  focus     Boolean
  rotation  Boolean
  tipTilt   Boolean
  anisopl   Boolean
  flexure   Boolean
}

model GuideAlarm {
  wfs     WfsType @id
  limit   Int
  enabled Boolean @default(true)
}

enum Site {
  GN
  GS
}

model CalParams {
  pk   Int  @id @default(autoincrement())
  site Site

  // Acquisition camera window center [pixels]
  acqCamX Float
  acqCamY Float

  // M2 Deployable Baffle wavelength cutoffs [microns]
  baffleVisible Float
  baffleNearIR  Float

  // Shutter current alarms [amps]
  topShutterCurrentLimit    Float
  bottomShutterCurrentLimit Float

  // A&G PWFS probeSel center command positions
  pwfs1CenterX Float
  pwfs1CenterY Float
  pwfs1CenterZ Float

  pwfs2CenterX Float
  pwfs2CenterY Float
  pwfs2CenterZ Float

  // True for GN, False for GS
  defocusEnabled  Boolean
  // SFO defocus offsets
  gnirsSfoDefocus Float?
  gmosSfoDefocus  Float?

  // LGS + P1 defocus offsets
  gnirsP1Defocus Float?
  gmosP1Defocus  Float?
  gmosOiDefocus  Float?

  comment   String?
  createdAt DateTime @default(now())
}
